{"version":3,"file":"seismograph.js","sources":["../../src/seismograph.js"],"sourcesContent":["// @flow\n\n/*\n * Philip Crotwell\n * University of South Carolina, 2019\n * http://www.seis.sc.edu\n */\n\n\nimport moment from 'moment';\nimport * as d3 from 'd3';\n\nimport {insertCSS} from './cssutil.js';\n\nimport {SeismographConfig,\n        DRAW_SVG, DRAW_CANVAS, DRAW_BOTH, DRAW_BOTH_ALIGN} from './seismographconfig';\nimport type { MarkerType } from './seismogram.js';\nimport type { MarginType } from './seismographconfig';\nimport {SeismogramDisplayData, findStartEnd, findMinMax, findMinMaxOverTimeRange,\n        SeismogramSegment, Seismogram, COUNT_UNIT } from './seismogram.js';\nimport {Quake} from './quakeml.js';\n\nimport * as util from './util.js';\nimport {StartEndDuration, isDef, isNumArg } from './util';\n\n\n\nconst CLIP_PREFIX = \"seismographclip\";\n\n\nexport type ScaleChangeListenerType = {\n  destinationKey: any,\n  notifyScaleChange: (value: any) => void\n}\n\n/* A seismogram plot, using d3. The actual waveform can be drawn\n  * with a separate Canvas (default) or with SVG.\n  * Note that for SVG you must have\n  * stroke and fill set in css like:<br>\n  * path.seispath {\n  *   stroke: skyblue;\n  *   fill: none;\n  * }<br/>\n  * in order to have the seismogram display.\n  */\nexport class Seismograph {\n  /** @private */\n  static _lastID: number;\n  plotId: number;\n  beforeFirstDraw: boolean;\n\n  svgParent: any;\n  seismographConfig: SeismographConfig;\n  seisDataList: Array<SeismogramDisplayData>;\n  alignmentSeisData: Array<SeismogramDisplayData>;\n\n  width: number;\n  height: number;\n  outerWidth: number;\n  outerHeight: number;\n  svg: any;\n  canvasHolder: any;\n  canvas: any;\n  origXScale: d3.scale;\n  currZoomXScale: any;\n  yScale: d3.scale; // for drawing seismogram\n  yScaleRmean: d3.scale; // for drawing y axis\n  yScaleData: d3.scale; // holds min max of data in time window\n  linkedAmpScale: LinkedAmpScale;\n  lineFunc: any;\n  zoom: any;\n  xAxis: any;\n  xAxisTop: any;\n  yAxis: any;\n  yAxisRight: any;\n  g: any;\n  throttleRescale: any;\n  throttleResize: any;\n  xScaleChangeListeners: Array<ScaleChangeListenerType>;\n  constructor(inSvgParent: any,\n              seismographConfig: SeismographConfig,\n              seisData: Array<SeismogramDisplayData> | Array<Seismogram> | SeismogramDisplayData | Seismogram) {\n    if (inSvgParent === null) {throw new Error(\"inSvgParent cannot be null\");}\n    if ( ! isDef(seismographConfig)) {\n      if (isDef(seisData) && ( ! Array.isArray(seisData) || seisData.length > 0)) {\n        // need at least one of seismographConfig or seisData to get time window\n        seismographConfig = new SeismographConfig();\n      } else {\n        throw new Error(\"seismographConfig and seisData cannot both be null\");\n      }\n    }\n    this.plotId = ++Seismograph._lastID;\n    this.beforeFirstDraw = true;\n    this.seismographConfig = seismographConfig;\n    this.seisDataList = [];\n    this._internalAppend(seisData);\n    this.alignmentSeisData = [];\n\n    this.width = 200;\n    this.height = 100;\n\n    if (typeof inSvgParent === 'string') {\n      this.svgParent = d3.select(inSvgParent);\n    } else {\n      this.svgParent = inSvgParent;\n    }\n\n    this.canvas = null;\n\n    this.svg = this.svgParent.append(\"svg\")\n      .style(\"z-index\", 100);\n    if (isNumArg(this.seismographConfig.minHeight) && this.seismographConfig.minHeight > 0) {\n      this.svg.style(\"min-height\", this.seismographConfig.minHeight+'px');\n    }\n    if (isNumArg(this.seismographConfig.maxHeight) && this.seismographConfig.maxHeight > 0) {\n      this.svg.style(\"max-height\", this.seismographConfig.maxHeight+'px');\n    }\n    this.svg.classed(\"seismograph\", true);\n    this.svg.attr(\"version\", \"1.1\");\n    this.svg.attr(\"plotId\", this.plotId);\n\n\n    this.calcTimeScaleDomain();\n    this.yScale = d3.scaleLinear();\n    this.yScaleData = d3.scaleLinear();\n    // yScale for axis (not drawing) that puts mean at 0 in center\n    this.yScaleRmean = d3.scaleLinear();\n    this.linkedAmpScale = new LinkedAmpScale([this]);\n\n    this.xScaleChangeListeners = [];\n\n    if (this.seismographConfig.isXAxis) {\n      this.xAxis = d3.axisBottom(this.currZoomXScale).tickFormat(this.seismographConfig.xScaleFormat);\n    }\n    if (this.seismographConfig.isXAxisTop) {\n      this.xAxisTop = d3.axisTop(this.currZoomXScale).tickFormat(this.seismographConfig.xScaleFormat);\n    }\n    if (this.seismographConfig.isYAxis) {\n      this.yAxis = d3.axisLeft(this.yScaleRmean).tickFormat(this.seismographConfig.yScaleFormat);\n    }\n    if (this.seismographConfig.isYAxisRight) {\n      this.yAxisRight = d3.axisRight(this.yScaleRmean).tickFormat(this.seismographConfig.yScaleFormat);\n    }\n\n    let mythis = this;\n\n    this.g = this.svg.append(\"g\")\n      .classed(\"marginTransform\", true)\n      .attr(\"transform\", \"translate(\" + this.seismographConfig.margin.left + \",\" + (this.seismographConfig.margin.top) + \")\");\n    this.g.append(\"g\").classed(\"allseismograms\", true);\n\n    let z = this.svg.call(d3.zoom().on(\"zoom\", function () {\n        mythis.zoomed(mythis);\n      }));\n    if ( ! this.seismographConfig.wheelZoom) {\n      z.on(\"wheel.zoom\", null);\n    }\n\n    this.calcAmpScaleDomain();\n\n    // create marker g\n    this.g.append(\"g\").attr(\"class\", \"allmarkers\")\n        .attr(\"style\", \"clip-path: url(#\"+CLIP_PREFIX+this.plotId+\")\");\n    d3.select(window).on('resize.canvasseismograph'+mythis.plotId, function() {\n      if ( ! mythis.beforeFirstDraw && mythis.checkResize() ) {\n        mythis.draw();\n      }\n    });\n\n  }\n  static fromSeismograms(inSvgParent: any,\n                seismographConfig: SeismographConfig,\n                seismogramList: Array<Seismogram>) {\n    return new Seismograph(inSvgParent,\n                           seismographConfig,\n                           seismogramList.map(s => SeismogramDisplayData.fromSeismogram(s)));\n  }\n\n  checkResize(): boolean {\n    let rect = this.svg.node().getBoundingClientRect();\n    if (rect.width !== this.outerWidth || rect.height !== this.outerHeight) {\n      return true;\n    }\n    return false;\n  }\n  draw(): void {\n    let rect = this.svg.node().getBoundingClientRect();\n    if ((rect.width !== this.outerWidth || rect.height !== this.outerHeight)) {\n      if (rect.height < this.seismographConfig.minHeight) {\n        rect.height = this.seismographConfig.minHeight;\n      }\n      if (rect.height > this.seismographConfig.maxHeight) {\n        rect.height = this.seismographConfig.maxHeight;\n      }\n      this.calcWidthHeight(rect.width, rect.height);\n    }\n    if (this.canvas) {\n      this.canvasHolder.attr(\"width\", this.width)\n         .attr(\"height\", this.height);\n      this.canvas.attr(\"width\", this.width)\n         .attr(\"height\", this.height);\n    } else {\n      this.canvasHolder = this.svg\n        .insert(\"foreignObject\",\":first-child\").classed(\"seismograph\", true)\n        .attr(\"x\", this.seismographConfig.margin.left)\n        .attr(\"y\", this.seismographConfig.margin.top)\n        .attr(\"width\", this.width)\n        .attr(\"height\", this.height+1);\n      this.canvas = this.canvasHolder.append(\"xhtml:canvas\").classed(\"seismograph\", true)\n        .attr(\"xmlns\", \"http://www.w3.org/1999/xhtml\")\n        .attr(\"x\", 0)\n        .attr(\"y\", 0)\n        .attr(\"width\", this.width)\n        .attr(\"height\", this.height+1);\n      const mythis = this;\n      let z = this.canvas.call(d3.zoom().on(\"zoom\", function () {\n          mythis.zoomed(mythis);\n        }));\n      if ( ! this.seismographConfig.wheelZoom) {\n        z.on(\"wheel.zoom\", null);\n      }\n\n      let style = window.getComputedStyle(this.svg.node());\n      let padTop = style.getPropertyValue('padding-top');\n      if (padTop.endsWith(\"px\")) {\n        padTop = Number(padTop.replace(\"px\", \"\"));\n      }\n      let borderTop = style.getPropertyValue('border-top-width');\n      if (borderTop.endsWith(\"px\")) {\n        borderTop = Number(borderTop.replace(\"px\", \"\"));\n      }\n    }\n    this.drawSeismograms();\n    this.drawAxis(this.g);\n    this.drawAxisLabels();\n    if (this.seismographConfig.doMarkers) {\n      this.drawMarkers();\n    }\n    this.beforeFirstDraw = false;\n    return this.svg;\n  }\n  printSizes(): void {\n    let out = \"\";\n    let rect = this.svg.node().getBoundingClientRect();\n    out += \"svg rect.height \"+rect.height+\"\\n\";\n    out += \"svg rect.width \"+rect.width+\"\\n\";\n    let grect = this.svgParent.node().getBoundingClientRect();\n    out += \"parent rect.height \"+grect.height+\"\\n\";\n    out += \"parent rect.width \"+grect.width+\"\\n\";\n      let crect = this.canvas.node().getBoundingClientRect();\n      out += \"c rect.height \"+crect.height+\"\\n\";\n      out += \"c rect.width \"+crect.width+\"\\n\";\n        out += \"c style.height \"+this.canvas.style(\"height\")+\"\\n\";\n        out += \"c style.width \"+this.canvas.style(\"width\")+\"\\n\";\n    out += \"this.height \"+this.height+\"\\n\";\n    out += \"this.width \"+this.width+\"\\n\";\n  out += \"canvas.height \"+this.canvas.node().height+\"\\n\";\n  out += \"canvas.width \"+this.canvas.node().width+\"\\n\";\n    out += \"this.outerHeight \"+this.outerHeight+\"\\n\";\n    out += \"this.outerWidth \"+this.outerWidth+\"\\n\";\n    // $FlowFixMe\n    out += \"this.margin \"+this.seismographConfig.margin+\"\\n\";\n    util.log(out);\n  }\n\n  drawSeismograms() {\n    if (this.seismographConfig.drawingType === DRAW_BOTH_ALIGN) {\n      if (this.alignmentSeisData.length === 0) {\n        const startenddur = new StartEndDuration(this.currZoomXScale.domain()[0], this.currZoomXScale.domain()[1]);\n        const fakeSDD = this.seismographConfig.createAlignmentData(startenddur);\n        this.alignmentSeisData.push(fakeSDD);\n      }\n    } else {\n      this.alignmentSeisData = [];\n    }\n    if (this.seismographConfig.drawingType === DRAW_CANVAS\n      || this.seismographConfig.drawingType === DRAW_BOTH\n      || this.seismographConfig.drawingType === DRAW_BOTH_ALIGN) {\n      this.drawSeismogramsCanvas();\n    }\n    if (this.seismographConfig.drawingType === DRAW_SVG\n      || this.seismographConfig.drawingType === DRAW_BOTH\n      || this.seismographConfig.drawingType === DRAW_BOTH_ALIGN) {\n      this.drawSeismogramsSvg();\n    }\n    if (this.seismographConfig.drawingType === DRAW_BOTH_ALIGN) {\n      this.drawCanvasAlignment();\n    }\n  }\n  isVisible(): boolean {\n    const elem = this.canvas.node();\n    if (! elem) { return false; }\n    return !!( elem.offsetWidth || elem.offsetHeight || elem.getClientRects().length );\n  }\n  drawSeismogramsCanvas(): void {\n    const mythis = this;\n    if (! this.isVisible()) {\n      // no need to draw if we are not visible\n      return;\n    }\n    // get the canvas drawing context\n    const canvasNode = this.canvas.node();\n    const context = canvasNode.getContext(\"2d\");\n    context.save();\n    // clear the canvas from previous drawing\n    context.clearRect(0, 0, canvasNode.width, canvasNode.height);\n\n    context.lineWidth = this.seismographConfig.lineWidth;\n    if (this.seismographConfig.drawingType === DRAW_BOTH_ALIGN) {\n      context.lineWidth = this.seismographConfig.lineWidth *2;\n    }\n\n    const plotStart = moment.utc(this.currZoomXScale.domain()[0]);\n    const plotEnd = moment.utc(this.currZoomXScale.domain()[1]);\n    const plotDuration = moment.duration(plotEnd.diff(plotStart));\n    const secondsPerPixel = plotDuration.asSeconds()/\n        (this.currZoomXScale.range()[1]-this.currZoomXScale.range()[0]);\n    const sddList = this.seisDataList.concat(this.alignmentSeisData);\n    sddList.forEach( (t,ti) => {\n      let color;\n      if (this.seismographConfig.drawingType === DRAW_BOTH_ALIGN) {\n        color = mythis.seismographConfig.getColorForIndex(ti + sddList.length);\n      } else {\n        color = mythis.seismographConfig.getColorForIndex(ti);\n      }\n\n      let firstTime = true;\n      if ( t.seismogram) {\n        t.seismogram.segments.forEach((s) => {\n          if (s.startTime.isAfter(plotEnd) ||\n              s.endTime.isBefore(plotStart)) {\n                // segment either totally off to left or right of visible\n                return;\n          }\n          const samplesPerPixel = 1.0*s.sampleRate*secondsPerPixel;\n          const pixelsPerSample = 1.0/samplesPerPixel;\n          const startPixel = this.currZoomXScale(s.startTime.toDate());\n          const endPixel = this.currZoomXScale(s.endTime.toDate());\n          let leftVisibleSample = 0;\n          let rightVisibleSample = s.y.length;\n          let leftVisiblePixel = startPixel;\n          if (startPixel < 0) {\n            leftVisibleSample = Math.floor(-1*startPixel*samplesPerPixel) -1;\n            leftVisiblePixel = 0;\n          }\n          if (endPixel > this.currZoomXScale.range()[1]+1) {\n            rightVisibleSample = leftVisibleSample+Math.ceil((this.width+1)*samplesPerPixel) +1;\n          }\n          if (firstTime || ! this.seismographConfig.connectSegments ){\n            context.beginPath();\n            context.strokeStyle = color;\n            //context.lineWidth = 5;\n            context.moveTo(leftVisiblePixel, this.yScale(s.y[leftVisibleSample]));\n            firstTime = false;\n          }\n          for(let i=leftVisibleSample; i<rightVisibleSample+2 && i<s.y.length; i++) {\n            context.lineTo(startPixel+i*pixelsPerSample, this.yScale(s.y[i]));\n          }\n          if (! this.seismographConfig.connectSegments ){\n            context.stroke();\n          }\n        });\n      } else {\n        util.log(`seisdata has no seismogram ${util.stringify(ti)}`);\n      }\n\n      if (this.seismographConfig.connectSegments ){\n        context.stroke();\n      }\n    });\n    context.restore();\n  }\n  drawCanvasAlignment(): void {\n    const mythis = this;\n    let radius = 10;\n    // draw corners in svg for comparison\n    let minX = this.currZoomXScale.domain()[0];\n    let maxX = this.currZoomXScale.domain()[1];\n    let minY = this.yScale.domain()[0];\n    let maxY = this.yScale.domain()[1];\n    this.g.selectAll(\"circle\").remove();\n    let circles = this.g.selectAll(\"circle\").data([ [minX, minY],\n                                      [minX, maxY],\n                                      [maxX, minY],\n                                      [maxX, maxY]]);\n    circles.exit().remove();\n    circles\n      .enter().append(\"circle\")\n      .attr('fill-opacity', '0.4')\n      .attr('cx', function(d){  return mythis.currZoomXScale(d[0]);})\n      .attr('cy', function(d){  return mythis.yScale(d[1]);})\n      .attr('r', radius-2);\n\n    this.g.selectAll(\"path.diagonal\").remove();\n    this.g.append(\"path\").attr(\"class\",  \"seispath diagonal\").attr(\"d\", \"M0,0L\"+mythis.currZoomXScale(maxX)+\", \"+mythis.yScale(minY));\n\n\n    // svg text color\n    let textcolor = this.seismographConfig.getColorForIndex(this.seisDataList.length);\n    let textcolorArr = [ textcolor];\n    this.g.selectAll(\"text\").data(textcolorArr).enter().append(\"text\").style(\"fill\", textcolor).text(\"svg \"+textcolor).attr(\"x\", this.width*3/4).attr(\"y\", this.height/4+20);\n\n\n    // get the canvas drawing context\n    const canvasNode = this.canvas.node();\n    //canvasNode.height = this.height;\n    //canvasNode.width = this.width;\n    const context = canvasNode.getContext(\"2d\");\n\n    // canvas text color\n    textcolor = this.seismographConfig.getColorForIndex(2*this.seisDataList.length+this.alignmentSeisData.length);\n    context.strokeStyle=textcolor;\n    context.strokeText(\"canvas \"+textcolor, this.width*3/4, this.height/4);\n\n    context.beginPath();\n    context.fillStyle = \"lightblue\";\n    context.arc(this.currZoomXScale((minX+maxX)/2), this.yScale((minY+maxY)/2), radius, 0, 2*Math.PI, true);\n    context.fill();\n\n    context.beginPath();\n    context.fillStyle = \"lightblue\";\n    context.arc(this.currZoomXScale(minX), this.yScale(minY), radius, 0, 2*Math.PI, true);\n    context.fill();\n    context.beginPath();\n    context.fillStyle = \"red\";\n    context.arc(this.currZoomXScale(maxX), this.yScale(minY), radius, 0, 2*Math.PI, true);\n    context.fill();\n    context.beginPath();\n    context.fillStyle = \"green\";\n    context.arc(this.currZoomXScale(minX), this.yScale(maxY), radius, 0, 2*Math.PI, true);\n    context.fill();\n    context.beginPath();\n    context.fillStyle = \"black\";\n    context.arc(this.currZoomXScale(maxX), this.yScale(maxY), radius, 0, 2*Math.PI, true);\n    context.fill();\n    context.beginPath();\n    context.moveTo(this.currZoomXScale(this.currZoomXScale.domain()[0]), this.yScaleRmean(0));\n    context.lineTo(this.currZoomXScale(this.currZoomXScale.domain()[1]), this.yScaleRmean(0));\n    context.moveTo(0,0);\n    context.lineTo(this.width, this.height);\n    context.stroke();\n  //  this.printSizes();\n  }\n  calcScaleAndZoom(): void {\n    this.rescaleYAxis();\n    // check if clip exists, wonky d3 convention\n    let container = this.svg.select(\"defs\").select(\"#\"+CLIP_PREFIX+this.plotId);\n    if (container.empty()) {\n      this.svg.append(\"defs\").append(\"clipPath\").attr(\"id\", CLIP_PREFIX+this.plotId);\n    }\n    let clip = this.svg.select(\"defs\").select(\"#\"+CLIP_PREFIX+this.plotId);\n\n    clip.selectAll(\"rect\").remove();\n    clip.append(\"rect\")\n            .attr(\"width\", this.width)\n            .attr(\"height\", this.height);\n  }\n  drawSeismogramsSvg() {\n    const sddList = this.seisDataList.concat(this.alignmentSeisData);\n    const mythis = this;\n    const allSegG = this.g.select(\"g.allseismograms\");\n    const traceJoin = allSegG.selectAll(\"g.seismogram\")\n      .data(sddList)\n      .enter()\n      .append(\"g\")\n        .attr(\"label\", s => s ? s.label : 'none')\n        .attr(\"codes\", s => s.seismogram && s.seismogram.hasCodes() ? s.seismogram.codes() : 'none')\n        .classed(\"seismogram\", true);\n    traceJoin.exit().remove();\n\n    const subtraceJoin = traceJoin\n      .selectAll('path')\n       .data(sdd => sdd.seismogram ? sdd.seismogram.segments : []);\n    subtraceJoin.enter()\n      .append(\"path\")\n        .classed(\"seispath\", true)\n        .classed(DRAW_BOTH_ALIGN, this.seismographConfig.drawingType === DRAW_BOTH_ALIGN)\n        .attr(\"style\", \"clip-path: url(#\"+CLIP_PREFIX+mythis.plotId+\")\")\n        .attr(\"shape-rendering\", \"crispEdges\")\n        .attr(\"d\", function(seg) {\n           return mythis.segmentDrawLine(seg, mythis.currZoomXScale);\n         });\n    subtraceJoin.exit().remove();\n  }\n\n  calcSecondsPerPixel(xScale: any): number {\n    let domain = xScale.domain(); // time so milliseconds\n    let range = xScale.range(); // pixels\n    return (domain[1].getTime()-domain[0].getTime())/1000 / (range[1]-range[0]);\n  }\n\n  segmentDrawLine(seg: SeismogramSegment, xScale: any): void {\n    const mythis = this;\n    let secondsPerPixel = this.calcSecondsPerPixel(xScale);\n    let samplesPerPixel = seg.sampleRate * secondsPerPixel;\n    let lineFunc = d3.line()\n      .curve(d3.curveLinear)\n      .x(function(d) {return xScale(d.time); })\n      .y(function(d) {return mythis.yScale(d.y); });\n    if (samplesPerPixel < this.seismographConfig.segmentDrawCompressedCutoff) {\n      if (! seg.y) {\n        // $FlowFixMe\n        util.log(\"canvasSeis seg.y not defined: \"+(typeof seg)+\" \"+(seg instanceof Seismogram));\n        return;\n      }\n      return lineFunc(Array.from(seg.y, function(d,i) {\n        return {time: seg.timeOfSample(i).toDate(), y: d };\n      }));\n    } else {\n      // lots of points per pixel so use high/low lines\n      if ( ! seg._highlow\n           || seg._highlow.secondsPerPixel !== secondsPerPixel\n           || seg._highlow.xScaleDomain[1] !== xScale.domain()[1]) {\n        let highlow = [];\n        let numHL = 2*Math.ceil(seg.y.length/samplesPerPixel);\n        for(let i=0; i<numHL; i++) {\n          let snippet = seg.y.slice(i * samplesPerPixel,\n                                    (i+1) * samplesPerPixel);\n          if (snippet.length !== 0) {\n          highlow[2*i] = snippet.reduce(function(acc, val) {\n            return Math.min(acc, val);\n          }, snippet[0]);\n          highlow[2*i+1] = snippet.reduce(function(acc, val) {\n            return Math.max(acc, val);\n          }, snippet[0]);\n          }\n        }\n        seg._highlow = {\n            xScaleDomain: xScale.domain(),\n            xScaleRange: xScale.range(),\n            secondsPerPixel: secondsPerPixel,\n            samplesPerPixel: samplesPerPixel,\n            highlowArray: highlow\n        };\n      }\n      return lineFunc(seg._highlow.highlowArray.map(function(d: number,i: number) {\n        return {time: new Date(seg.startTime.valueOf()+1000*((Math.floor(i/2)+.5)*secondsPerPixel)), y: d };\n      }));\n    }\n  }\n\n  drawAxis(svgG: any): void {\n    svgG.selectAll(\"g.axis\").remove();\n    if (this.seismographConfig.isXAxis) {\n      this.xAxis.scale(this.currZoomXScale);\n      this.xAxis.tickFormat(this.seismographConfig.xScaleFormat);\n      svgG.append(\"g\")\n          .attr(\"class\", \"axis axis--x\")\n          .attr(\"transform\", \"translate(0,\" + this.height + \")\")\n          .call(this.xAxis);\n    }\n    if (this.seismographConfig.isXAxisTop) {\n      this.xAxisTop.scale(this.currZoomXScale);\n      this.xAxisTop.tickFormat(this.seismographConfig.xScaleFormat);\n      svgG.append(\"g\")\n          .attr(\"class\", \"axis axis--x\")\n          .call(this.xAxisTop);\n    }\n    if (this.seismographConfig.isYAxis) {\n      this.yAxis.scale(this.yScaleRmean);\n      this.yAxis.ticks(8, this.seismographConfig.yScaleFormat);\n      svgG.append(\"g\")\n          .attr(\"class\", \"axis axis--y\")\n          .call(this.yAxis);\n    }\n    if (this.seismographConfig.isYAxisRight) {\n      this.yAxisRight.scale(this.yScaleRmean);\n      this.yAxisRight.ticks(8, this.seismographConfig.yScaleFormat);\n      svgG.append(\"g\")\n          .attr(\"class\", \"axis axis--y-right\")\n          .attr(\"transform\", \"translate(\" + this.width + \",0)\")\n          .call(this.yAxisRight);\n    }\n  }\n\n  rescaleYAxis(): void {\n    if ( ! this.beforeFirstDraw) {\n      let delay = 500;\n      let myThis = this;\n      if (this.throttleRescale) {\n        window.clearTimeout(this.throttleRescale);\n      }\n      this.throttleRescale = window.setTimeout(\n        function(){\n          if (myThis.seismographConfig.isYAxis) {\n            myThis.g.select(\".axis--y\").transition().duration(delay/2).call(myThis.yAxis);\n          }\n          if (myThis.seismographConfig.isYAxisRight) {\n            myThis.g.select(\".axis--y-right\").transition().duration(delay/2).call(myThis.yAxisRight);\n          }\n          myThis.throttleRescale = null;\n        }, delay);\n    }\n  }\n\n  drawAxisLabels(): void {\n    this.drawTitle();\n    this.drawXLabel();\n    this.drawXSublabel();\n    this.drawYLabel();\n    this.drawYSublabel();\n  }\n\n  cloneXScale(scale: d3.scale): d3.scale {\n    let outxScale = d3.scaleUtc();\n    outxScale.domain([scale.domain()[0], scale.domain()[1]]);\n    outxScale.range([scale.range()[0], scale.range()[1]]);\n    return outxScale;\n  }\n  resetZoom(): void {\n    this.redrawWithXScale(this.cloneXScale(this.origXScale));\n  }\n\n  zoomed(mythis: Seismograph): void {\n    let t = d3.event.transform;\n    let xt = t.rescaleX(this.origXScale);\n    mythis.redrawWithXScale(xt);\n  }\n\n  redrawWithXScale(xt: any): void {\n    if (xt.range()[0] === this.currZoomXScale.range()[0]\n        && xt.range()[1] === this.currZoomXScale.range()[1]\n        && xt.domain()[0].getTime() === this.currZoomXScale.domain()[0].getTime()\n        && xt.domain()[1].getTime() === this.currZoomXScale.domain()[1].getTime()) {\n      return;\n    }\n    let prevZoomXScale = this.currZoomXScale;\n    this.currZoomXScale = xt;\n    let mythis = this;\n    if (! this.beforeFirstDraw) {\n      this.g.select(\"g.allseismograms\").selectAll(\"g.seismogram\").remove();\n      if (this.seismographConfig.windowAmp) {\n        this.calcAmpScaleDomain();\n      }\n      this.drawSeismograms();\n      this.g.select(\"g.allmarkers\").selectAll(\"g.marker\")\n            .attr(\"transform\", function(marker: MarkerType) {\n              let textx = xt( marker.time.toDate());\n              return  \"translate(\"+textx+\",\"+0+\")\";});\n\n       this.g.select(\"g.allmarkers\").selectAll(\"g.markertext\")\n           .attr(\"transform\", function() {\n               // shift up by this.seismographConfig.markerTextOffset percentage\n               let maxY = mythis.yScale.range()[0];\n               let deltaY = mythis.yScale.range()[0]-mythis.yScale.range()[1];\n               let texty = maxY - mythis.seismographConfig.markerTextOffset*(deltaY);\n               return  \"translate(\"+0+\",\"+texty+\") rotate(\"+mythis.seismographConfig.markerTextAngle+\")\";\n             });\n\n       this.g.select(\"g.allmarkers\").selectAll(\"path.markerpath\")\n         .attr(\"d\", () => {\n           return d3.line()\n             .x(function() {\n               return 0; // g is translated so marker time is zero\n             }).y(function(d, i) {\n               return (i===0) ? 0 : mythis.yScale.range()[0];\n             }).curve(d3.curveLinear)([ mythis.yScale.domain()[0], mythis.yScale.domain()[1] ] ); // call the d3 function created by line with data\n        });\n        let startEnd = new StartEndDuration(prevZoomXScale.domain()[0], prevZoomXScale.domain()[1]);\n        let undrawnMarkers = this.seisDataList.reduce((acc, sdd) => {\n            sdd.markerList.forEach(m => acc.push(m));\n            return acc;\n          }, []).filter( m => ! startEnd.contains(m.time));\n        if (undrawnMarkers.length !== 0) {\n          this.drawMarkers();\n        }\n\n      if (this.seismographConfig.isXAxis) {\n        this.g.select(\".axis--x\").call(this.xAxis.scale(xt));\n      }\n      if (this.seismographConfig.isXAxisTop) {\n        this.g.select(\".axis--x-top\").call(this.xAxisTop.scale(xt));\n      }\n    }\n    this.xScaleChangeListeners.forEach(l => l.notifyScaleChange(xt));\n  }\n\n  drawMarkers() {\n    let startEnd = new StartEndDuration(this.currZoomXScale.domain()[0], this.currZoomXScale.domain()[1]);\n    let allMarkers = this.seisDataList.reduce((acc, sdd) => {\n        sdd.markerList.forEach(m => acc.push(m));\n        return acc;\n      }, []).filter( m => startEnd.contains(m.time));\n    // marker overlay\n    let mythis = this;\n    let markerG = this.g.select(\"g.allmarkers\");\n    markerG.selectAll(\"g.marker\").remove();\n    let labelSelection = markerG.selectAll(\"g.marker\")\n        .data(allMarkers, function(d) {\n              // key for data\n              return `${d.name}_${d.time.toISOString()}`;\n            });\n    labelSelection.exit().remove();\n\n    let radianTextAngle = this.seismographConfig.markerTextAngle*Math.PI/180;\n\n    labelSelection.enter()\n        .append(\"g\")\n        .classed(\"marker\", true)\n           // translate so marker time is zero\n        .attr(\"transform\", function(marker) {\n            let textx = mythis.currZoomXScale( marker.time.toDate());\n            return  \"translate(\"+textx+\",\"+0+\")\";\n          })\n        .each(function(marker) {\n\n          let drawG = d3.select(this);\n          drawG.classed(marker.name, true)\n            .classed(marker.type, true);\n\n          let innerTextG = drawG.append(\"g\")\n            .attr(\"class\", \"markertext\")\n            .attr(\"transform\", () => {\n              // shift up by this.seismographConfig.markerTextOffset percentage\n              let maxY = mythis.yScale.range()[0];\n              let deltaY = mythis.yScale.range()[0]-mythis.yScale.range()[1];\n              let texty = maxY - mythis.seismographConfig.markerTextOffset*(deltaY);\n              return  \"translate(\"+0+\",\"+texty+\") rotate(\"+mythis.seismographConfig.markerTextAngle+\")\";});\n          innerTextG.append(\"title\").text( marker => {\n            if (marker.description) {\n              return marker.description;\n            } else {\n              return marker.name+\" \"+marker.time.toISOString();\n            }\n          });\n          let textSel = innerTextG.append(\"text\");\n          if (marker.link && marker.link.length > 0) {\n            // if marker has link, make it clickable\n            textSel.append(\"svg:a\")\n              .attr(\"xlink:href\",function(marker) {return marker.link;})\n              .text(function(marker) {return marker.name;});\n          } else {\n            textSel.text(function(marker) {return marker.name;});\n          }\n          textSel\n              .attr(\"dy\", \"-0.35em\")\n              .call(function(selection) {\n                // this stores the BBox of the text in the bbox field for later use\n                selection.each(function(t){\n                    // set a default just in case\n                    t.bbox = {height: 15, width:20};\n                    try {\n                      t.bbox = this.getBBox();\n                    } catch(error) {\n                      // eslint-disable-next-line no-console\n                      console.warn(error);\n                      // this happens if the text is not yet in the DOM, I think\n                      //  https://bugzilla.mozilla.org/show_bug.cgi?id=612118\n                    }\n                });\n              });\n          // draw/insert flag behind/before text\n          innerTextG.insert(\"polygon\", \"text\")\n              .attr(\"points\", function(marker) {\n                let bboxH = marker.bbox.height+5;\n                let bboxW = marker.bbox.width;\n                return \"0,0 \"\n                  +(-1*bboxH*Math.tan(radianTextAngle))+\",-\"+bboxH+\" \"\n                  +bboxW+\",-\"+bboxH+\" \"\n                  +bboxW+\",0\";\n              });\n// let style be in css?\n//              .style(\"fill\", \"rgba(220,220,220,.4)\");\n          drawG.append(\"path\")\n            .classed(\"markerpath\", true)\n            .attr(\"d\", () => {\n              return d3.line()\n                .x(0) // g is translated so marker time is zero\n                .y(function(d, i) {\n                  let out = 0;\n                  if (mythis.seismographConfig.markerFlagpoleBase === 'center') {\n                    out = (i===0) ? 0: (mythis.yScale.range()[0]+mythis.yScale.range()[1])/2 ;\n                  } else {\n                    // mythis.seismographConfig.markerFlagpoleBase === 'bottom'\n                    out = (i===0) ? 0 : mythis.yScale.range()[0];\n                  }\n                  return out;\n                }).curve(d3.curveLinear)([ mythis.yScale.domain()[0], mythis.yScale.domain()[1] ] ); // call the d3 function created by line with data\n\n            });\n        });\n  }\n\n  calcWidthHeight(nOuterWidth: number, nOuterHeight: number): void {\n    if (nOuterWidth < this.seismographConfig.margin.left + this.seismographConfig.margin.right) {\n      throw new Error(`width too small for margin: ${nOuterWidth} < ${this.seismographConfig.margin.left} + ${this.seismographConfig.margin.right}`);\n    }\n    if (nOuterHeight < this.seismographConfig.margin.top + this.seismographConfig.margin.bottom) {\n      throw new Error(`height too small for margin: ${nOuterWidth} < ${this.seismographConfig.margin.top} + ${this.seismographConfig.margin.bottom}`);\n    }\n    this.outerWidth = nOuterWidth;\n    this.outerHeight = nOuterHeight;\n    this.height = this.outerHeight - this.seismographConfig.margin.top - this.seismographConfig.margin.bottom;\n    this.width = this.outerWidth - this.seismographConfig.margin.left - this.seismographConfig.margin.right;\n    this.origXScale.range([0, this.width]);\n    this.yScale.range([this.height, 0]);\n    this.yScaleRmean.range([this.height, 0]);\n    if (this.seismographConfig.isYAxis) {\n      this.yAxis.scale(this.yScaleRmean);\n    }\n    if (this.seismographConfig.isYAxisRight) {\n      this.yAxisRight.scale(this.yScaleRmean);\n    }\n    this.calcScaleAndZoom();\n    if (this.canvas) {\n      this.canvasHolder.attr(\"width\", this.width)\n        .attr(\"height\", this.height+1);\n      this.canvas.attr(\"width\", this.width)\n        .attr(\"height\", this.height+1);\n    }\n    const resizeXScale = this.cloneXScale(this.currZoomXScale);\n    // keep same time window\n    // but use new pixel range\n    resizeXScale.range([0, this.width]);\n    // this updates currZoomXScale\n    this.redrawWithXScale(resizeXScale);\n  }\n\n\n  // see http://blog.kevinchisholm.com/javascript/javascript-function-throttling/\n  throttle(func: () => void, delay: number): void {\n    if (this.throttleResize) {\n      window.clearTimeout(this.throttleResize);\n    }\n    this.throttleResize = window.setTimeout(func, delay);\n  }\n\n  resizeNeeded() {\n    let myThis = this;\n    this.throttle(function(){\n        myThis.draw();\n    }, 250);\n  }\n\n  setMargin(value: MarginType ): Seismograph {\n    this.seismographConfig.margin = value;\n    if ( ! this.beforeFirstDraw) {\n      this.calcWidthHeight(this.outerWidth, this.outerHeight);\n      this.g.attr(\"transform\", \"translate(\" + this.seismographConfig.margin.left + \",\" + this.seismographConfig.margin.top + \")\");\n    }\n    return this;\n  }\n  drawTitle() {\n    this.svg.selectAll(\"g.title\").remove();\n    let titleSVGText = this.svg.append(\"g\")\n       .classed(\"title\", true)\n       .attr(\"transform\", \"translate(\"+(this.seismographConfig.margin.left+(this.width)/2)+\", \"+0+\")\")\n       .append(\"text\").classed(\"title label\", true)\n       .attr(\"x\",0).attr(\"y\",0)\n       .attr(\"text-anchor\", \"middle\");\n    if (Array.isArray(this.seismographConfig.title)) {\n      this.seismographConfig.title.forEach(function(s) {\n        titleSVGText.append(\"tspan\").text(s+\" \");\n      });\n    } else {\n      titleSVGText\n        .text(this.seismographConfig.title);\n    }\n  }\n  drawXLabel(): Seismograph {\n    this.svg.selectAll(\"g.xLabel\").remove();\n    if (this.seismographConfig.xLabel && this.seismographConfig.xLabel.length > 0) {\n      this.svg.append(\"g\")\n         .classed(\"xLabel\", true)\n         .attr(\"transform\", \"translate(\"+(this.seismographConfig.margin.left+(this.width)/2)+\", \"+(this.outerHeight - this.seismographConfig.margin.bottom/3  )+\")\")\n         .append(\"text\").classed(\"x label\", true)\n         .attr(\"text-anchor\", \"middle\")\n         .text(this.seismographConfig.xLabel);\n    }\n    return this;\n  }\n  drawYLabel(): Seismograph {\n    this.svg.selectAll('g.yLabel').remove();\n    for(let side of [ 'left', 'right']) {\n      let hTranslate = (side===\"left\"?0:this.seismographConfig.margin.left+this.width+1);\n      let svgText = this.svg.append(\"g\")\n         .classed(\"yLabel\", true)\n         .classed(side, true)\n         .attr(\"x\", 0)\n         .attr(\"transform\", `translate(${hTranslate}, ${(this.seismographConfig.margin.top+(this.height)/2)})`)\n         .append(\"text\");\n      svgText\n         .classed(\"y label\", true);\n      if (this.seismographConfig.yLabelOrientation === \"vertical\") {\n        // vertical\n        svgText\n          .attr(\"text-anchor\", \"middle\")\n          .attr(\"dy\", \".75em\")\n          .attr(\"transform\", \"rotate(-90, 0, 0)\");\n      } else {\n        // horizontal\n        svgText.attr(\"text-anchor\", \"start\")\n        .attr(\"dominant-baseline\", \"central\");\n      }\n      if (side===\"left\") {\n        svgText.text(this.seismographConfig.yLabel);\n      } else {\n        svgText.text(this.seismographConfig.yLabelRight);\n      }\n    }\n    return this;\n  }\n  drawXSublabel(): Seismograph {\n    this.svg.selectAll('g.xSublabel').remove();\n    this.svg.append(\"g\")\n       .classed(\"xSublabel\", true)\n       .attr(\"transform\", \"translate(\"+(this.seismographConfig.margin.left+(this.width)/2)+\", \"+(this.outerHeight  )+\")\")\n       .append(\"text\").classed(\"x label sublabel\", true)\n       .attr(\"text-anchor\", \"middle\")\n       .text(this.seismographConfig.xSublabel);\n    return this;\n  }\n  drawYSublabel(): Seismograph {\n    this.svg.selectAll('g.ySublabel').remove();\n    let svgText = this.svg.append(\"g\")\n       .classed(\"ySublabel\", true)\n       .attr(\"x\", 0)\n       .attr(\"transform\", \"translate( \"+this.seismographConfig.ySublabelTrans+\" , \"+(this.seismographConfig.margin.top+(this.height)/2)+\")\")\n       .append(\"text\")\n       .classed(\"y label sublabel\", true);\n    if (this.seismographConfig.yLabelOrientation === \"vertical\") {\n      // vertical\n      svgText\n        .attr(\"text-anchor\", \"middle\")\n        .attr(\"dy\", \".75em\")\n        .attr(\"transform\", \"rotate(-90, 0, 0)\");\n    } else {\n      // horizontal\n      svgText.attr(\"text-anchor\", \"start\")\n      .attr(\"dominant-baseline\", \"central\");\n    }\n    svgText\n       .text(this.seismographConfig.ySublabel);\n    return this;\n  }\n  calcTimeScaleDomain(): void {\n      let timeWindow;\n      if (this.seismographConfig.fixedTimeScale) {\n        timeWindow = this.seismographConfig.fixedTimeScale;\n      } else {\n        timeWindow = findStartEnd(this.seisDataList);\n      }\n      if ( ! isDef(this.origXScale)) {\n        this.origXScale = d3.scaleUtc();\n      }\n      this.origXScale.domain([timeWindow.startTime.toDate(), timeWindow.endTime.toDate()]);\n      // force to be same but not to share same array\n      this.currZoomXScale = this.cloneXScale(this.origXScale);\n  }\n  calcAmpScaleDomain(): void {\n    const oldMinMax = this.yScaleData.domain();\n    if (this.seismographConfig.fixedYScale) {\n      this.yScaleData.domain(this.seismographConfig.fixedYScale);\n      this.yScale.domain(this.seismographConfig.fixedYScale);\n    } else {\n      let minMax;\n      if (this.seismographConfig.windowAmp) {\n        let timeWindow = new StartEndDuration(this.currZoomXScale.domain()[0], this.currZoomXScale.domain()[1]);\n        minMax = findMinMaxOverTimeRange(this.seisDataList, timeWindow);\n      } else {\n        minMax = findMinMax(this.seisDataList);\n      }\n      if (minMax[0] === minMax[1]) {\n        // flatlined data, use -1, +1\n        minMax = [ minMax[0]-1, minMax[1]+1];\n      }\n      this.yScaleData.domain(minMax);\n\n      if (this.linkedAmpScale) {\n        if (oldMinMax[0] !== minMax[0] || oldMinMax[1] !== minMax[1]) {\n          this.linkedAmpScale.recalculate(); // sets yScale.domain\n        }\n      } else {\n        this.yScale.domain(minMax);\n        if (this.seismographConfig.isYAxisNice) {\n          this.yScale.nice();\n        }\n        this.redoDisplayYScale();\n      }\n\n    }\n  }\n  redoDisplayYScale(): void {\n    let niceMinMax = this.yScale.domain();\n    if (this.seismographConfig.doGain\n        && this.seisDataList.length > 0\n        && this.seisDataList.every(sdd => sdd.hasSensitivity())\n        && this.seisDataList.every(sdd => sdd.seismogram.yUnit === COUNT_UNIT )) {\n      // each has seisitivity\n      const firstSensitivity = this.seisDataList[0].sensitivity;\n      if (isDef(firstSensitivity) && this.seisDataList.every(sdd => (\n          isDef(firstSensitivity) && sdd.sensitivity\n          && firstSensitivity.sensitivity===sdd.sensitivity.sensitivity\n          && firstSensitivity.inputUnits===sdd.sensitivity.inputUnits\n          && firstSensitivity.outputUnits===sdd.sensitivity.outputUnits\n        ))) {\n          niceMinMax[0] = niceMinMax[0] / firstSensitivity.sensitivity;\n          niceMinMax[1] = niceMinMax[1] / firstSensitivity.sensitivity;\n          if (this.seismographConfig.ySublabelIsUnits) {\n            this.seismographConfig.ySublabel = firstSensitivity.inputUnits;\n          }\n      } else {\n        throw new Error(\"doGain with different seisitivities not yet implemented.\");\n      }\n    } else {\n      if (this.seismographConfig.ySublabelIsUnits ) {\n        this.seismographConfig.ySublabel = \"\";\n        let allUnits = [];\n        for (let t of this.seisDataList) {\n          if (t.seismogram){\n            let u = t.seismogram.yUnit;\n            allUnits.push(u);\n            this.seismographConfig.ySublabel += `${u} `;\n          }\n        }\n        if (allUnits.length === 0) {\n          allUnits.push(\"Count\");\n        }\n        this.seismographConfig.ySublabel = allUnits.join(' ');\n      }\n    }\n    if (this.seismographConfig.doRMean) {\n      this.seismographConfig.ySublabel = `centered ${this.seismographConfig.ySublabel}`;\n      this.yScaleRmean.domain([ (niceMinMax[0]-niceMinMax[1])/2, (niceMinMax[1]-niceMinMax[0])/2 ]);\n    } else {\n      this.yScaleRmean.domain(niceMinMax);\n    }\n    this.rescaleYAxis();\n    this.drawYSublabel();\n  }\n  getSeismogramData(): Array<SeismogramDisplayData> {\n    return this.seisDataList;\n  }\n  /**\n   * can append single seismogram segment or an array of segments.\n   *\n   * @param sddList array or single SeismogramDisplayData or Seismogram\n   * @private\n   */\n  _internalAppend(sddList: Array<SeismogramDisplayData> | SeismogramDisplayData | Array<Seismogram> | Seismogram  ): void {\n    if ( ! sddList) {\n      // don't append a null\n    } else if (Array.isArray(sddList)) {\n      for(let s of sddList) {\n        if (s instanceof SeismogramDisplayData ) {\n          this.seisDataList.push(s);\n        } else {\n          this.seisDataList.push(SeismogramDisplayData.fromSeismogram(s));\n        }\n      }\n    } else {\n      if (sddList instanceof SeismogramDisplayData ) {\n        this.seisDataList.push(sddList);\n      } else {\n        this.seisDataList.push(SeismogramDisplayData.fromSeismogram(sddList));\n      }\n    }\n  }\n  /**\n   * appends the seismogram(s) or SeismogramDisplayData as separate time series.\n   *\n   * @param seismogram data to append\n   * @returns this Seismograph\n   */\n  append(seismogram: Array<Seismogram> | Seismogram | SeismogramDisplayData) {\n    if (seismogram instanceof SeismogramDisplayData) {\n      this._internalAppend(seismogram);\n    } else if (Array.isArray(seismogram)) {\n      let sdd = seismogram.map(s => SeismogramDisplayData.fromSeismogram(s));\n      this._internalAppend(sdd);\n    } else if (seismogram instanceof Seismogram) {\n      this._internalAppend(SeismogramDisplayData.fromSeismogram(seismogram));\n    } else {\n      throw new Error(`Unable to append, doesn't look like Array of Seismogram, Seismogram or SeismogramDisplayData: ${seismogram.constructor.name}`);\n    }\n    this.calcAmpScaleDomain();\n    if ( ! this.beforeFirstDraw) {\n      // only trigger a draw if appending after already drawn on screen\n      // otherwise, just append the data and wait for outside to call first draw()\n      this.drawSeismograms();\n    }\n    return this;\n  }\n  /**\n   * Finds the SeismogramDisplayData within the display containing the given\n   * Seismogram.\n   *\n   * @param   seis seismogram to search for\n   * @returns       SeismogramDisplayData if found or null if not\n   */\n  getDisplayDataForSeismogram(seis: Seismogram): SeismogramDisplayData | null {\n    let out = this.seisDataList.find(sd => sd.seismogram === seis);\n    if (out) {return out; } else { return null;}\n  }\n  /**\n   * Removes a seismogram from the display.\n   *\n   * @param   seisData seis data to remove\n   */\n  remove(seisData: SeismogramDisplayData): void {\n    this.seisDataList = this.seisDataList.filter( sd => sd !== seisData);\n  }\n  /**\n   * Removes seismograms that do not overlap the window.\n   *\n   * @param   timeWindow overlap data to keep\n   */\n  trim(timeWindow: StartEndDuration): void {\n    if (this.seisDataList) {\n      this.seisDataList = this.seisDataList.filter(function(d) {\n        return d.timeWindow.overlaps(timeWindow);\n      });\n      if (this.seisDataList.length > 0) {\n        this.calcAmpScaleDomain();\n        this.drawSeismograms();\n      }\n    }\n  }\n  linkXScaleTo(seismograph: Seismograph) {\n    this.origXScale.domain(seismograph.origXScale.domain());\n    this.currZoomXScale.domain(seismograph.currZoomXScale.domain());\n    if ( ! this.beforeFirstDraw && seismograph.currZoomXScale.range()[1] !== 1) {\n      // default range is 0,1, so don't draw then.\n      this.redrawWithXScale(seismograph.currZoomXScale);\n    }\n    if ( ! this.xScaleChangeListeners.find(l => l.destinationKey === seismograph)) {\n      this.xScaleChangeListeners.push({\n          destinationKey: seismograph,\n          notifyScaleChange: function(xScale) {\n            if ( ! seismograph.beforeFirstDraw) {\n              seismograph.redrawWithXScale(xScale);\n            }\n          }\n        });\n    }\n    if (! seismograph.xScaleChangeListeners.find(l => l.destinationKey === this)) {\n      seismograph.linkXScaleTo(this);\n    }\n  }\n  unlinkXScaleTo(seismograph: Seismograph) {\n    this.xScaleChangeListeners = this.xScaleChangeListeners.filter( l => l.destinationKey !==seismograph);\n    if (seismograph.xScaleChangeListeners.find(l => l.destinationKey === this)) {\n      seismograph.unlinkXScaleTo(this);\n    }\n  }\n}\n\n/**\n * Links amplitude scales across multiple seismographs, respecting doRmean.\n *\n * @param graphList optional list of Seismographs to link\n */\nexport class LinkedAmpScale {\n  /**\n   * @private\n   */\n  _graphSet: Set<Seismograph>;\n  constructor(graphList: ?Array<Seismograph>) {\n    const glist = graphList ? graphList : []; // in case null\n    this._graphSet = new Set(glist);\n    this._graphSet.forEach(g => {\n      g.linkedAmpScale = this;\n    });\n  }\n  /**\n   * Link new Seismograph with this amplitude scale.\n   *\n   * @param   graph Seismograph to link\n   */\n  link(graph: Seismograph) {\n    this._graphSet.add(graph);\n    graph.linkedAmpScale = this;\n    this.recalculate();\n  }\n  /**\n   * Unlink Seismograph with this amplitude scale.\n   *\n   * @param   graph Seismograph to unlink\n   */\n  unlink(graph: Seismograph) {\n    this._graphSet.delete(graph);\n    this.recalculate();\n  }\n  /**\n   * Recalculate the best amplitude scale for all Seismographs. Causes a redraw.\n   */\n  recalculate() {\n    const graphList = Array.from(this._graphSet.values());\n    const maxRange = graphList.reduce((acc, cur) => {\n      let graphMaxRange = cur.yScaleData.domain()[1]-cur.yScaleData.domain()[0];\n      return acc >  graphMaxRange ? acc : graphMaxRange;\n    }, 0);\n    const min = graphList.reduce((acc, cur) => {\n      let graphMin = cur.yScaleData.domain()[0];\n      return acc < graphMin ? acc : graphMin;\n    }, Number.MAX_SAFE_INTEGER);\n    const max = graphList.reduce((acc, cur) => {\n      let graphMax = cur.yScaleData.domain()[1];\n      return acc > graphMax ? acc : graphMax;\n    }, -1*Number.MAX_SAFE_INTEGER);\n    graphList.forEach(g => {\n      if (g.seismographConfig.doRMean) {\n        const mean = (g.yScaleData.domain()[1]+g.yScaleData.domain()[0]) / 2;\n        g.yScale.domain([mean-maxRange/2, mean+maxRange/2]);\n        g.yScaleRmean.domain([-1*maxRange/2, maxRange/2]);\n      } else {\n        g.yScale.domain([min, max]);\n        g.yScaleRmean.domain([min, max]);\n      }\n      g.redoDisplayYScale();\n      if ( ! g.beforeFirstDraw) {\n        // only trigger a draw if appending after already drawn on screen\n        // otherwise, just append the data and wait for outside to call first draw()\n        g.draw();\n      }\n    });\n  }\n}\n\n\n// static ID for seismogram\nSeismograph._lastID = 0;\n\n/**\n * Creates Markers for all of the arrivals in ttime.arrivals, relative\n * to the given Quake.\n *\n * @param   quake quake the travel times are relative to\n * @param   ttime travel times json object as returned from the\n * IRIS traveltime web service, or the json output of TauP\n * @returns        array of Markers suitable for adding to a seismograph\n */\nexport function createMarkersForTravelTimes(quake: Quake, ttime: any): Array<MarkerType> {\n  return ttime.arrivals.map( a => {\n    return {\n      type: 'predicted',\n      name: a.phase,\n      time: moment.utc(quake.time).add(a.time, 'seconds')\n    };\n  });\n}\n\nexport const seismograph_css = `\n\n\n.marker .markerpath {\n  fill: none;\n  stroke: black;\n  stroke-width: 1px;\n}\n\n.marker polygon {\n  fill: rgba(150,220,150,.4);\n}\n\n.marker.predicted polygon {\n  fill: rgba(220,220,220,.4);\n}\n\n.marker.pick polygon {\n  fill: rgba(255,100,100,.4);\n}\n\npath.seispath {\n  stroke: skyblue;\n  fill: none;\n  stroke-width: 1px;\n}\n\npath.orientZ {\n  stroke: seagreen;\n}\n\npath.orientN {\n  stroke: cornflowerblue;\n}\n\npath.orientE {\n  stroke: orange;\n}\n\npath.alignment {\n  stroke-dasharray: 8;\n  stroke-width: 2px;\n}\n\nsvg.seismograph {\n  height: 100%;\n  width: 100%;\n  min-height: 25px;\n  min-width: 25px;\n}\n\nsvg.seismograph g.ySublabel text {\n  font-size: smaller;\n}\n\nsvg.seismograph g.xSublabel text {\n  font-size: smaller;\n}\n\nsvg.seismograph text.title {\n  font-size: larger;\n  font-weight: bold;\n  fill: black;\n  color: black;\n  dominant-baseline: hanging;\n}\n\nsvg.realtimePlot g.allseismograms path.seispath {\n  stroke: skyblue;\n}\n\nsvg.seismograph g.allseismograms g:nth-child(9n+1) path.seispath {\n  stroke: skyblue;\n}\n\nsvg.seismograph g.allseismograms g:nth-child(9n+2) path.seispath {\n  stroke: olivedrab;\n}\n\nsvg.seismograph g.allseismograms g:nth-child(9n+3) path.seispath {\n  stroke: goldenrod;\n}\n\nsvg.seismograph g.allseismograms g:nth-child(9n+4) path.seispath {\n  stroke: firebrick;\n}\n\nsvg.seismograph g.allseismograms g:nth-child(9n+5) path.seispath {\n  stroke: darkcyan;\n}\n\nsvg.seismograph g.allseismograms g:nth-child(9n+6) path.seispath {\n  stroke: orange;\n}\n\nsvg.seismograph g.allseismograms g:nth-child(9n+7) path.seispath {\n  stroke: darkmagenta;\n}\n\nsvg.seismograph g.allseismograms g:nth-child(9n+8) path.seispath {\n  stroke: mediumvioletred;\n}\n\nsvg.seismograph g.allseismograms g:nth-child(9n+9) path.seispath {\n  stroke: sienna;\n}\n\n/* same colors for titles */\n\nsvg.seismograph g.title text tspan:nth-child(9n+1)  {\n  fill: skyblue;\n}\n\nsvg.seismograph g.title text tspan:nth-child(9n+2)  {\n  stroke: olivedrab;\n}\n\nsvg.seismograph g.title text tspan:nth-child(9n+3)  {\n  stroke: goldenrod;\n}\n\nsvg.seismograph g.title tspan:nth-child(9n+4)  {\n  stroke: firebrick;\n}\n\nsvg.seismograph g.title tspan:nth-child(9n+5)  {\n  stroke: darkcyan;\n}\n\nsvg.seismograph g.title tspan:nth-child(9n+6)  {\n  stroke: orange;\n}\n\nsvg.seismograph g.title tspan:nth-child(9n+7)  {\n  stroke: darkmagenta;\n}\n\nsvg.seismograph g.title tspan:nth-child(9n+8)  {\n  stroke: mediumvioletred;\n}\n\nsvg.seismograph g.title tspan:nth-child(9n+9)  {\n  stroke: sienna;\n}\n\n\n/* links in svg */\nsvg.seismograph text a {\n  fill: #0000EE;\n  text-decoration: underline;\n}\n\n`;\n\nif (document){\n  insertCSS(seismograph_css);\n}\n"],"names":["CLIP_PREFIX","Seismograph","constructor","inSvgParent","seismographConfig","seisData","Error","isDef","Array","isArray","length","SeismographConfig","plotId","_lastID","beforeFirstDraw","seisDataList","_internalAppend","alignmentSeisData","width","height","svgParent","d3","canvas","svg","append","style","isNumArg","minHeight","maxHeight","classed","attr","calcTimeScaleDomain","yScale","yScaleData","yScaleRmean","linkedAmpScale","LinkedAmpScale","xScaleChangeListeners","isXAxis","xAxis","currZoomXScale","tickFormat","xScaleFormat","isXAxisTop","xAxisTop","isYAxis","yAxis","yScaleFormat","isYAxisRight","yAxisRight","mythis","g","margin","left","top","z","call","on","zoomed","wheelZoom","calcAmpScaleDomain","window","checkResize","draw","fromSeismograms","seismogramList","map","s","SeismogramDisplayData","fromSeismogram","rect","node","getBoundingClientRect","outerWidth","outerHeight","calcWidthHeight","canvasHolder","insert","getComputedStyle","padTop","getPropertyValue","endsWith","Number","replace","borderTop","drawSeismograms","drawAxis","drawAxisLabels","doMarkers","drawMarkers","printSizes","out","grect","crect","util","drawingType","DRAW_BOTH_ALIGN","startenddur","StartEndDuration","domain","fakeSDD","createAlignmentData","push","DRAW_CANVAS","DRAW_BOTH","drawSeismogramsCanvas","DRAW_SVG","drawSeismogramsSvg","drawCanvasAlignment","isVisible","elem","offsetWidth","offsetHeight","getClientRects","canvasNode","context","getContext","save","clearRect","lineWidth","plotStart","moment","utc","plotEnd","plotDuration","duration","diff","secondsPerPixel","asSeconds","range","sddList","concat","forEach","t","ti","color","getColorForIndex","firstTime","seismogram","segments","startTime","isAfter","endTime","isBefore","samplesPerPixel","sampleRate","pixelsPerSample","startPixel","toDate","endPixel","leftVisibleSample","rightVisibleSample","y","leftVisiblePixel","Math","floor","ceil","connectSegments","beginPath","strokeStyle","moveTo","i","lineTo","stroke","restore","radius","minX","maxX","minY","maxY","selectAll","remove","circles","data","exit","enter","d","textcolor","textcolorArr","text","strokeText","fillStyle","arc","PI","fill","calcScaleAndZoom","rescaleYAxis","container","select","empty","clip","allSegG","traceJoin","label","hasCodes","codes","subtraceJoin","sdd","seg","segmentDrawLine","calcSecondsPerPixel","xScale","getTime","lineFunc","curve","x","time","segmentDrawCompressedCutoff","Seismogram","from","timeOfSample","_highlow","xScaleDomain","highlow","numHL","snippet","slice","reduce","acc","val","min","max","xScaleRange","highlowArray","Date","valueOf","svgG","scale","ticks","delay","myThis","throttleRescale","clearTimeout","setTimeout","transition","drawTitle","drawXLabel","drawXSublabel","drawYLabel","drawYSublabel","cloneXScale","outxScale","resetZoom","redrawWithXScale","origXScale","transform","xt","rescaleX","prevZoomXScale","windowAmp","marker","textx","deltaY","texty","markerTextOffset","markerTextAngle","startEnd","undrawnMarkers","markerList","m","filter","contains","l","notifyScaleChange","allMarkers","markerG","labelSelection","name","toISOString","radianTextAngle","each","drawG","type","innerTextG","description","textSel","link","selection","bbox","getBBox","error","console","warn","bboxH","bboxW","tan","markerFlagpoleBase","nOuterWidth","nOuterHeight","right","bottom","resizeXScale","throttle","func","throttleResize","resizeNeeded","setMargin","value","titleSVGText","title","xLabel","side","hTranslate","svgText","yLabelOrientation","yLabel","yLabelRight","xSublabel","ySublabelTrans","ySublabel","timeWindow","fixedTimeScale","findStartEnd","oldMinMax","fixedYScale","minMax","findMinMaxOverTimeRange","findMinMax","recalculate","isYAxisNice","nice","redoDisplayYScale","niceMinMax","doGain","every","hasSensitivity","yUnit","COUNT_UNIT","firstSensitivity","sensitivity","inputUnits","outputUnits","ySublabelIsUnits","allUnits","u","join","doRMean","getSeismogramData","getDisplayDataForSeismogram","seis","find","sd","trim","overlaps","linkXScaleTo","seismograph","destinationKey","unlinkXScaleTo","graphList","glist","_graphSet","Set","graph","add","unlink","delete","values","maxRange","cur","graphMaxRange","graphMin","MAX_SAFE_INTEGER","graphMax","mean","createMarkersForTravelTimes","quake","ttime","arrivals","a","phase","seismograph_css","document","insertCSS"],"mappings":"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"}